# Oracle Skills CLI - Architecture Documentation

## Overview

**oracle-skills-cli** is a universal CLI installer that distributes Oracle skills (AI-assistant workflows) to 14+ coding agents (Claude Code, OpenCode, Cursor, Codex, etc.). It manages skill discovery, installation pipelines, and agent detection across both local (project) and global (user) directories.

**Repository**: https://github.com/Soul-Brews-Studio/oracle-skills-cli
**Current Version**: 1.5.72
**Runtime**: Bun (Node.js ≥18 compatible)
**Language**: TypeScript

---

## 1. Directory Structure

```
oracle-skills-cli/
├── src/
│   ├── cli/                          # CLI entry point & core installer logic
│   │   ├── index.ts                  # Main CLI (commander, prompts, flow control)
│   │   ├── agents.ts                 # Agent configs (15 agents) & detection
│   │   ├── types.ts                  # AgentConfig, AgentType, Skill, InstallOptions
│   │   ├── installer.ts              # Installation/uninstallation pipelines
│   │   └── fs-utils.ts               # Cross-platform file ops (Bun $ vs Node fs)
│   │
│   ├── skills/                       # 29+ skills (each a workflow)
│   │   ├── _template/                # Template for new skills
│   │   │   ├── SKILL.md              # Markdown instructions for agents
│   │   │   └── scripts/
│   │   │       └── main.ts           # Optional Bun script
│   │   │
│   │   ├── awaken/                   # Guided Oracle creation (~15 min)
│   │   ├── trace/                    # Unified discovery system (git/MCP/agents)
│   │   ├── learn/                    # Explore codebases
│   │   ├── rrr/                      # Session retrospective (reflection)
│   │   ├── project/                  # Clone & track external repos
│   │   ├── [24 more skills...]
│   │   │
│   │   └── [each skill]:
│   │       ├── SKILL.md              # Frontmatter + instructions
│   │       ├── scripts/              # Optional execution code
│   │       ├── hooks/                # Optional hooks.json (Claude Code plugins)
│   │       └── templates/            # Optional templates for output
│   │
│   ├── commands/                     # Compiled command stubs (generated by bun run compile)
│   │   ├── awaken.md
│   │   ├── trace.md
│   │   └── [26 more .md files...]   # Each points to corresponding skill
│   │
│   └── hooks/                        # Agent-specific plugins
│       └── opencode/
│           └── oracle-skills.ts      # OpenCode plugin (adds timestamp to user messages)
│
├── scripts/
│   ├── compile.ts                    # Generates src/commands/*.md from src/skills/*/SKILL.md
│   ├── generate-table.ts             # Parses skills for README table
│   ├── update-readme-table.ts        # Updates README.md with latest skill list
│   └── release.sh                    # Git tag & publish workflow
│
├── __tests__/                        # Test suite (Bun test)
├── package.json                      # v1.5.72, bin: oracle-skills
├── tsconfig.json                     # ES2022, strict mode
├── bun.lock                          # Bun dependency lock
└── README.md                         # Installation, skill list, agent support
```

### Key Directory Purposes

| Path | Purpose | Ownership |
|------|---------|-----------|
| `src/cli/` | Entry point, agent detection, install/uninstall logic | Core |
| `src/skills/` | 29 runnable skills bundled in repo | Plugins |
| `src/commands/` | Compiled stubs that agents read; **generated file** | Build artifact |
| `src/hooks/` | Agent-specific plugins (OpenCode timestamp) | Integrations |
| `scripts/` | Build tooling (compile, README generation) | Automation |

---

## 2. Entry Points

### CLI Invocation

```bash
#!/usr/bin/env bun
# Location: src/cli/index.ts line 1
```

**Why Bun shebang?**
- Bun-specific features: template literals in import.meta, `$` shell, Bun.file()
- Bun.$ is faster than Node.js child_process for file operations
- Falls back to Node.js ≥18 for most operations via `fs-utils.ts`

### Package.json Entry

```json
{
  "bin": {
    "oracle-skills": "./src/cli/index.ts"
  },
  "scripts": {
    "build": "bun build src/cli/index.ts --outdir dist --target bun --minify",
    "dev": "bun run src/cli/index.ts",
    "compile": "bun scripts/compile.ts",
    "version": "bun run compile && bun scripts/update-readme-table.ts && git add src/commands README.md"
  }
}
```

**build**: Creates `/dist/` for publishing to npm (not in repo, only in dist folder)
**compile**: Generates command stubs from skill SKILL.md files
**version**: Pre-release hook (updates src/commands/ and README table)

### Installation Flow

```bash
# Users run (typically via curl|bash install.sh):
bunx --bun oracle-skills@github:Soul-Brews-Studio/oracle-skills-cli#v1.5.72 install -g -y
```

This fetches from GitHub without npm publishing.

---

## 3. Core Abstractions

### AgentConfig (types.ts:1-11)

```typescript
interface AgentConfig {
  name: string;                      // 'claude-code', 'opencode', etc.
  displayName: string;               // "Claude Code", "OpenCode"
  skillsDir: string;                 // '.claude/skills' (local)
  globalSkillsDir: string;           // '~/.claude/skills' (global)
  commandsDir?: string;              // '.claude/commands' (flat files)
  globalCommandsDir?: string;        // '~/.claude/commands'
  useFlatFiles?: boolean;            // true = skillname.md, false = skillname/SKILL.md
  commandsOptIn?: boolean;           // true = only install with --commands flag
  detectInstalled: () => boolean;    // Check if agent is on system
}
```

**useFlatFiles**: OpenCode reads `.opencode/commands/*.md` (flat). Claude Code reads `.claude/skills/skillname/SKILL.md` (nested).

**commandsOptIn**: Claude Code only installs commands if `--commands` flag passed; OpenCode always installs.

### Skill Type (types.ts:29-33)

```typescript
interface Skill {
  name: string;           // 'awaken', 'trace', 'rrr'
  description: string;    // From SKILL.md frontmatter
  path: string;           // /src/skills/awaken
}
```

### AgentType Union (types.ts:13-27)

15 supported agents:
- **Mainstream**: claude-code, opencode, codex, cursor
- **Alternative editors**: kilo, roo, goose, windsurf
- **Specialized**: gemini, antigravity, copilot, clawdbot, droid, amp

### InstallOptions (types.ts:37-44)

```typescript
interface InstallOptions {
  global?: boolean;          // ~/.claude/skills vs ./.claude/skills
  skills?: string[];         // Filter to specific skill names
  yes?: boolean;             // Skip prompts
  commands?: boolean;        // Install command stubs (for commandsOptIn agents)
  shellMode?: ShellMode;     // 'auto'|'shell'|'no-shell' for fs operations
}
```

### ShellMode (fs-utils.ts:4)

```typescript
type ShellMode = 'auto' | 'shell' | 'no-shell';
```

- `auto`: Use Bun.$ on Unix, Node.js fs on Windows
- `shell`: Force Bun.$ (test Windows on macOS)
- `no-shell`: Force Node.js fs (if Bun.$ fails)

---

## 4. Skill Discovery & Loading

### Discovery Pipeline (installer.ts:40-67)

```typescript
async function discoverSkills(): Promise<Skill[]> {
  const skillsPath = getSkillsDir();  // /src/skills (relative to CLI)

  // Read directories, skip _.* and _template
  const skillDirs = readdirSync(skillsPath, { withFileTypes: true })
    .filter(d => d.isDirectory() && !d.name.startsWith('.') && d.name !== '_template')
    .map(d => d.name);

  // For each, read SKILL.md frontmatter
  const skills: Skill[] = [];
  for (const name of skillDirs) {
    const skillMdPath = join(skillsPath, name, 'SKILL.md');
    if (existsSync(skillMdPath)) {
      const content = await Bun.file(skillMdPath).text();
      const descMatch = content.match(/description:\s*(.+)/);
      skills.push({
        name,
        description: descMatch?.[1]?.trim() || '',
        path: join(skillsPath, name),
      });
    }
  }
  return skills;
}
```

**Source**: Bundled in `src/skills/*/SKILL.md` (not downloaded at runtime)

### Skill Structure

```
awaken/
├── SKILL.md                    # Frontmatter + instructions
└── [optional] scripts/
    └── main.ts                 # Bun shell script (if needed)
```

**SKILL.md Format** (awaken/SKILL.md:1-4):
```yaml
---
name: awaken
description: Guided Oracle birth and awakening ritual (~15 min). Use when creating a new Oracle...
---
# /awaken - Oracle Awakening Ritual
[Instructions in markdown, read by agent]
```

### List Command (index.ts:219-286)

```bash
oracle-skills list -g
```

Shows installed skills with version extraction from SKILL.md frontmatter:
```typescript
const versionMatch = content.match(/v(\d+\.\d+\.\d+)/);
if (versionMatch) {
  version = ` (v${versionMatch[1]})`;
}
```

---

## 5. Agent System (14+ Agents)

### Agent Configuration (agents.ts:8-114)

**All 15 agents defined in single object:**

```typescript
export const agents: Record<AgentType, AgentConfig> = {
  'claude-code': {
    name: 'claude-code',
    displayName: 'Claude Code',
    skillsDir: '.claude/skills',
    globalSkillsDir: join(home, '.claude/skills'),
    commandsDir: '.claude/commands',
    globalCommandsDir: join(home, '.claude/commands'),
    useFlatFiles: true,
    commandsOptIn: true,  // Only install commands with --commands flag
    detectInstalled: () => existsSync(join(home, '.claude')),
  },
  opencode: {
    name: 'opencode',
    displayName: 'OpenCode',
    skillsDir: '.opencode/skills',
    globalSkillsDir: join(home, '.config/opencode/skills'),
    commandsDir: '.opencode/commands',
    globalCommandsDir: join(home, '.config/opencode/commands'),
    useFlatFiles: true,
    detectInstalled: () => existsSync(join(home, '.config/opencode')),
  },
  cursor: {
    name: 'cursor',
    displayName: 'Cursor',
    skillsDir: '.cursor/skills',
    globalSkillsDir: join(home, '.cursor/skills'),
    detectInstalled: () => existsSync(join(home, '.cursor')),
  },
  // [12 more agents...]
};
```

### Agent Detection (agents.ts:116-120)

```typescript
export function detectInstalledAgents(): string[] {
  return Object.entries(agents)
    .filter(([_, config]) => config.detectInstalled())
    .map(([name]) => name);
}
```

**Detection examples**:
- Claude Code: Check `~/.claude/` exists
- OpenCode: Check `~/.config/opencode/` exists
- Cursor: Check `~/.cursor/` exists

### Agent Directories (agents.ts:9-113)

| Agent | Project | Global | Detection |
|-------|---------|--------|-----------|
| claude-code | `.claude/skills/` | `~/.claude/skills/` | `~/.claude` |
| opencode | `.opencode/skills/` | `~/.config/opencode/skills/` | `~/.config/opencode` |
| cursor | `.cursor/skills/` | `~/.cursor/skills/` | `~/.cursor` |
| codex | `.codex/skills/` | `~/.codex/skills/` | `~/.codex` |
| amp | `.agents/skills/` | `~/.config/agents/skills/` | `~/.config/amp` |
| kilo | `.kilocode/skills/` | `~/.kilocode/skills/` | `~/.kilocode` |
| roo | `.roo/skills/` | `~/.roo/skills/` | `~/.roo` |
| goose | `.goose/skills/` | `~/.config/goose/skills/` | `~/.config/goose` |
| gemini | `.gemini/skills/` | `~/.gemini/skills/` | `~/.gemini` |
| antigravity | `.agent/skills/` | `~/.gemini/antigravity/skills/` | `~/.gemini/antigravity` |
| copilot | `.github/skills/` | `~/.copilot/skills/` | `~/.copilot` |
| clawdbot | `skills/` | `~/.clawdbot/skills/` | `~/.clawdbot` |
| droid | `.factory/skills/` | `~/.factory/skills/` | `~/.factory` |
| windsurf | `.windsurf/skills/` | `~/.codeium/windsurf/skills/` | `~/.codeium/windsurf` |

---

## 6. Installation Pipeline

### Install Flow (installer.ts:87-364)

**Command**: `oracle-skills install [options]`

#### Step 1: Agent Selection

```typescript
// Auto-detect if no agents specified
let targetAgents: string[] = options.agent || [];

if (targetAgents.length === 0) {
  const detected = detectInstalledAgents();
  if (detected.length > 0) {
    p.log.info(`Detected agents: ${detected.join(', ')}`);
    if (!options.yes) {
      const useDetected = await p.confirm({
        message: 'Install to detected agents?',
      });
      if (useDetected) targetAgents = detected;
    } else {
      targetAgents = detected;
    }
  }
}

// If still no agents, prompt user to select
if (targetAgents.length === 0) {
  const selected = await p.multiselect({
    message: 'Select agents to install to:',
    options: Object.entries(agents).map(([key, config]) => ({
      value: key,
      label: config.displayName,
      hint: options.global ? config.globalSkillsDir : config.skillsDir,
    })),
    required: true,
  });
  targetAgents = selected;
}
```

#### Step 2: Skill Selection

```typescript
// Get all available skills from src/skills/
const allSkills = await discoverSkills();

// Filter if --skill specified
let skillsToInstall = allSkills;
if (options.skills && options.skills.length > 0) {
  skillsToInstall = allSkills.filter((s) => options.skills!.includes(s.name));
}

// Confirm installation (unless --yes)
if (!options.yes) {
  const confirmed = await p.confirm({
    message: `Install ${skillsToInstall.length} skills to ${agentList}?`,
  });
  if (!confirmed) return;
}
```

#### Step 3: Orphan Cleanup (installer.ts:137-186)

**Auto-cleanup**: Removes skills that were installed by oracle-skills-cli but no longer exist in source.

```typescript
// Only cleanup if: 1) marked as "installer: oracle-skills-cli" 2) not in source anymore
async function isOurSkill(skillPath: string): Promise<boolean> {
  const skillMdPath = join(skillPath, 'SKILL.md');
  if (!existsSync(skillMdPath)) return false;
  try {
    const content = await Bun.file(skillMdPath).text();
    return content.includes('installer: oracle-skills-cli');
  } catch {
    return false;
  }
}

// For each agent's skills directory
const sourceSkillNames = allSkills.map((s) => s.name);
const installedDirs = readdirSync(targetDir);

for (const installed of installedDirs) {
  if (await isOurSkill(installedPath) && !sourceSkillNames.includes(installed)) {
    // Move to trash directory (not delete, preserving "Nothing is Deleted")
    const trashDir = join(tmpdir(), `oracle-skills-stale-${timestamp}`);
    await mv(installedPath, join(trashDir, basename(installedPath)));
    p.log.info(`Cleaned up orphan: ${installed} → ${trashDir}`);
  }
}
```

#### Step 4: Copy Skills to Target Directory (installer.ts:188-230)

```typescript
for (const skill of skillsToInstall) {
  const destPath = join(targetDir, skill.name);

  // Remove existing
  if (existsSync(destPath)) {
    await rmrf(destPath, shellMode);
  }

  // Copy entire skill folder
  await cpr(skill.path, destPath, shellMode);

  // Inject version & installer marker into SKILL.md frontmatter
  const skillMdPath = join(destPath, 'SKILL.md');
  if (existsSync(skillMdPath)) {
    let content = await Bun.file(skillMdPath).text();
    if (content.startsWith('---')) {
      // Add installer field
      content = content.replace(
        /^---\n/,
        `---\ninstaller: oracle-skills-cli v${pkg.version}\n`
      );
      // Prepend version & scope to description (G=Global, L=Local)
      const scopeChar = scope === 'Global' ? 'G' : 'L';
      content = content.replace(
        /^(description:\s*)(.+?)(\n)/m,
        `$1v${pkg.version} ${scopeChar}-SKLL | $2$3`
      );
      await Bun.write(skillMdPath, content);
    }
  }
}
```

#### Step 5: Handle Skills with Hooks (installer.ts:232-264)

Skills can have hooks (Claude Code plugins):

```typescript
function hasHooks(skillPath: string): boolean {
  return existsSync(join(skillPath, 'hooks', 'hooks.json'));
}

// For skills with hooks, also install to ~/.claude/plugins/
if (skillsWithHooks.length > 0) {
  const pluginsDir = join(homedir(), '.claude', 'plugins');
  await mkdirp(pluginsDir, shellMode);

  for (const skill of skillsWithHooks) {
    const pluginDest = join(pluginsDir, skill.name);
    if (existsSync(pluginDest)) {
      await rmrf(pluginDest, shellMode);
    }

    // Copy entire skill as plugin
    await cpr(skill.path, pluginDest, shellMode);

    // Create .claude-plugin/plugin.json if not exists
    const pluginJsonDir = join(pluginDest, '.claude-plugin');
    const pluginJsonPath = join(pluginJsonDir, 'plugin.json');
    if (!existsSync(pluginJsonPath)) {
      await mkdirp(pluginJsonDir, shellMode);
      const pluginJson = {
        name: skill.name,
        description: skill.description,
        version: pkg.version,
        author: { name: 'Soul Brews Studio' },
      };
      await Bun.write(pluginJsonPath, JSON.stringify(pluginJson, null, 2));
    }
  }
}
```

#### Step 6: Write Manifests (installer.ts:266-300)

Two metadata files written to each agent's skills directory:

**`.oracle-skills.json`**: Machine-readable manifest
```json
{
  "version": "1.5.72",
  "installedAt": "2026-02-07T13:49:00.000Z",
  "skills": ["awaken", "trace", "learn", ...],
  "agent": "claude-code"
}
```

**`VERSION.md`**: Human-readable version info
```markdown
# Oracle Skills

Installed by: **oracle-skills-cli v1.5.72**
Installed at: 2026-02-07T13:49:00.000Z
Agent: Claude Code
Skills: 29

## Report This Version

When asked about skills version, report:
\`\`\`
oracle-skills-cli v1.5.72
\`\`\`

## Installed Skills

- awaken
- trace
- learn
...

## Update Skills

\`\`\`bash
bunx --bun oracle-skills@github:Soul-Brews-Studio/oracle-skills-cli#v1.5.72 install -y -g
\`\`\`
```

#### Step 7: Install Command Stubs (installer.ts:303-345)

For agents with `commandsDir` and not opt-in, or with --commands flag:

```typescript
if (agent.commandsDir && (!agent.commandsOptIn || options.commands)) {
  const commandsDir = options.global
    ? agent.globalCommandsDir!
    : join(process.cwd(), agent.commandsDir);
  await mkdirp(commandsDir, shellMode);

  const scopeChar = scope === 'Global' ? 'G' : 'L';

  for (const skill of skillsToInstall) {
    const skillMdPath = join(targetDir, skill.name, 'SKILL.md');
    if (existsSync(skillMdPath)) {
      // Create stub that points to full skill
      const stubContent = `---
description: v${pkg.version} ${scopeChar}-CMD | ${skill.description}
allowed-tools:
  - Bash
  - Read
  - Write
  - Edit
  - Glob
  - Grep
  - Task
  - WebFetch
---

# /${skill.name}

Execute the \`${skill.name}\` skill with args: \`$ARGUMENTS\`

**If you have a Skill tool available**: Use it directly with \`skill: "${skill.name}"\` instead of reading the file manually.

**Otherwise**: Read the skill file at \`${skillsPath}/${skill.name}/SKILL.md\` and follow ALL instructions in it.

---
*oracle-skills-cli v${pkg.version}*
`;
      const commandPath = join(commandsDir, `${skill.name}.md`);
      await Bun.write(commandPath, stubContent);
    }
  }
}
```

#### Step 8: OpenCode Plugin (installer.ts:347-358)

Special handling for OpenCode's oracle-skills plugin:

```typescript
if (agentName === 'opencode') {
  const pluginDir = options.global
    ? join(homedir(), '.config/opencode/plugins')
    : join(process.cwd(), '.opencode/plugins');
  await mkdirp(pluginDir, shellMode);

  const hookSrc = join(dirname(import.meta.path), '..', 'hooks', 'opencode', 'oracle-skills.ts');
  if (existsSync(hookSrc)) {
    await cp(hookSrc, join(pluginDir, 'oracle-skills.ts'), shellMode);
    p.log.success(`OpenCode plugin: ${pluginDir}/oracle-skills.ts`);
  }
}
```

---

## 7. Compilation System

### Compile Command (package.json:17)

```bash
bun run compile
```

### Compilation Pipeline (scripts/compile.ts:12-82)

Generates command stubs from skill SKILL.md files:

```typescript
async function compile() {
  const SKILLS_DIR = join(process.cwd(), 'src', 'skills');
  const COMMANDS_DIR = join(process.cwd(), 'src', 'commands');

  if (!existsSync(COMMANDS_DIR)) {
    await mkdir(COMMANDS_DIR);
  }

  const skills = await readdir(SKILLS_DIR, { withFileTypes: true });
  let count = 0;

  for (const dirent of skills) {
    if (!dirent.isDirectory() || dirent.name.startsWith('.') || dirent.name === '_template') continue;

    const skillName = dirent.name;
    const skillPath = join(SKILLS_DIR, skillName, 'SKILL.md');

    if (existsSync(skillPath)) {
      const content = await readFile(skillPath, 'utf-8');

      // Parse YAML frontmatter
      const parts = content.split(/^---\s*$/m);

      if (parts.length >= 3) {
        const frontmatter = parts[1];
        const descMatch = frontmatter.match(/description:\s*(.+)$/m);
        const rawDescription = descMatch ? descMatch[1].trim() : `${skillName} skill`;
        const description = `v${pkg.version} | ${rawDescription}`;

        // Create stub command
        const commandContent = `---
description: ${description}
---

# /${skillName}

Execute the \`${skillName}\` skill with the provided arguments.

## Instructions

**If you have a Skill tool available**: Use it directly with \`skill: "${skillName}"\` instead of reading the file manually.

**Otherwise**:
1. Read the skill file: \`{skillPath}/${skillName}/SKILL.md\`
2. Follow all instructions in the skill file
3. Pass these arguments to the skill: \`$ARGUMENTS\`

## Skill Location

- Local: \`.claude/skills/${skillName}/SKILL.md\`
- Global: \`~/.claude/skills/${skillName}/SKILL.md\`

---
*oracle-skills-cli v${pkg.version}*
`;

        await writeFile(join(COMMANDS_DIR, `${skillName}.md`), commandContent);
        console.log(`✓ ${skillName} (v${pkg.version})`);
        count++;
      }
    }
  }

  console.log(`\n✨ Compiled ${count} skill stubs to ${COMMANDS_DIR}`);
}
```

### Output

- **Input**: `src/skills/*/SKILL.md` (29 skills)
- **Output**: `src/commands/*.md` (29 compiled stubs)
- **Version**: Injected from package.json
- **Placeholder**: `{skillPath}` replaced at install time with actual path

### Integration with Release (package.json:18)

```json
"version": "bun run compile && bun scripts/update-readme-table.ts && git add src/commands README.md"
```

Runs before each release to:
1. Recompile all command stubs
2. Update README.md skill table
3. Stage changes in git

---

## 8. Dependencies

### Runtime Dependencies (package.json:53-57)

| Package | Version | Purpose |
|---------|---------|---------|
| `@clack/prompts` | ^0.7.0 | CLI prompts (select, confirm, spinner) |
| `commander` | ^12.0.0 | CLI argument parsing |
| `mqtt` | ^5.14.1 | MQTT WebSocket for Gemini integration |

**Why these?**
- `@clack/prompts`: Beautiful, responsive CLI UX with spinners
- `commander`: Industry standard CLI framework (used by eslint, webpack, etc.)
- `mqtt`: Used by `/gemini` skill to control Gemini via MQTT pub/sub

### Dev Dependencies (package.json:47-51)

| Package | Version | Purpose |
|---------|---------|---------|
| `@types/bun` | ^1.3.6 | TypeScript definitions for Bun runtime |
| `@types/node` | ^20.0.0 | TypeScript definitions for Node.js |
| `lefthook` | ^2.0.15 | Git hooks (pre-commit linting) |
| `typescript` | ^5.0.0 | TypeScript compiler |

### Implicit Dependencies

**Bun provides**:
- `$` shell for file operations (Bun.$ and Bun.file())
- Native TypeScript compilation
- Child process management

**Node.js provides** (fallback):
- `fs` module (mkdirSync, cpSync, rmSync, etc.)
- `path` module
- `os` module (homedir, tmpdir)

---

## 9. Hook System

### Hook Registration (installer.ts:22-25)

```typescript
function hasHooks(skillPath: string): boolean {
  return existsSync(join(skillPath, 'hooks', 'hooks.json'));
}
```

### Hook File Structure

```
skill-name/
├── SKILL.md
├── hooks/
│   └── hooks.json              # Hook configuration (checked by installer)
└── [other files]
```

### OpenCode Plugin Hook (hooks/opencode/oracle-skills.ts)

```typescript
/**
 * Oracle Skills Plugin for OpenCode
 * Adds "opencode-cli:" prefix with timestamp (GMT+7)
 */
import type { Plugin } from "@opencode-ai/plugin"

const OracleSkillsPlugin: Plugin = () => ({
  name: "oracle-skills",

  "experimental.chat.messages.transform": (_input: any, output: any) => {
    if (output?.messages && Array.isArray(output.messages)) {
      for (const msg of output.messages) {
        const role = msg.info?.role || msg.role
        if (role === "user" && msg.parts && Array.isArray(msg.parts)) {
          for (const part of msg.parts) {
            if (part.type === "text" && part.text && !part.text.startsWith(PREFIX)) {
              const timestamp = getTimestamp()
              part.text = `${PREFIX} [${timestamp} GMT+7] ${part.text}`
            }
          }
        }
      }
    }
  },
})

export default OracleSkillsPlugin
```

**What it does**:
- Intercepts user messages in OpenCode
- Adds `opencode-cli: [HH:MM GMT+7]` prefix to each message
- Helps identify when messages were sent for session tracking

### Hook Installation Flow

1. Installer detects `hasHooks(skillPath)` → true
2. Copies entire skill folder to `~/.claude/plugins/[skillName]`
3. Creates `.claude-plugin/plugin.json` with metadata
4. Agent loads plugin on next restart

---

## 10. Configuration & Version Tracking

### Manifest Files

After installation, two files track configuration:

**`.oracle-skills.json`** (installer.ts:267-273):
```json
{
  "version": "1.5.72",
  "installedAt": "2026-02-07T13:49:00.000Z",
  "skills": ["awaken", "trace", "learn"],
  "agent": "claude-code"
}
```

**`VERSION.md`** (installer.ts:276-300):
```markdown
# Oracle Skills

Installed by: **oracle-skills-cli v1.5.72**
Installed at: 2026-02-07T13:49:00.000Z
Agent: Claude Code
Skills: 29

## Report This Version
...
```

### SKILL.md Frontmatter Injection (installer.ts:211-228)

During installation, frontmatter is modified:

**Before**:
```yaml
---
name: awaken
description: Guided Oracle birth and awakening ritual (~15 min)
---
```

**After**:
```yaml
---
name: awaken
installer: oracle-skills-cli v1.5.72
description: v1.5.72 G-SKLL | Guided Oracle birth and awakening ritual (~15 min)
---
```

**Markers**:
- `installer:` - Identifies skills installed by this tool
- `v1.5.72` - Version prefix
- `G-SKLL` - Scope (G=Global, L=Local)
- `L-CMD` - Command type (in command stubs)

### Version in Command Stubs (installer.ts:315-341)

```markdown
---
description: v1.5.72 L-CMD | Execute the awaken skill
---

# /awaken

...
```

Agents can parse description to report skill version to users.

---

## 11. File Operations (fs-utils.ts)

### Cross-Platform Implementation

**Problem**: Windows doesn't support Bun.$ reliably for all operations.

**Solution**: Provide both Bun and Node.js implementations with mode switching.

```typescript
export type ShellMode = 'auto' | 'shell' | 'no-shell';

const isWindows = process.platform === 'win32';

function useShell(mode: ShellMode): boolean {
  if (mode === 'shell') return true;
  if (mode === 'no-shell') return false;
  return !isWindows;  // auto: shell on Unix, fs on Windows
}

export async function mkdirp(dir: string, mode: ShellMode = 'auto'): Promise<void> {
  if (useShell(mode)) {
    await $`mkdir -p ${dir}`.quiet();
  } else {
    mkdirSync(dir, { recursive: true });
  }
}

export async function rmrf(path: string, mode: ShellMode = 'auto'): Promise<void> {
  if (!existsSync(path)) return;
  if (useShell(mode)) {
    await $`rm -rf ${path}`.quiet();
  } else {
    rmSync(path, { recursive: true, force: true });
  }
}

export async function cpr(src: string, dest: string, mode: ShellMode = 'auto'): Promise<void> {
  if (useShell(mode)) {
    await $`cp -r ${src} ${dest}`.quiet();
  } else {
    cpSync(src, dest, { recursive: true });
  }
}

export async function mv(src: string, dest: string, mode: ShellMode = 'auto'): Promise<void> {
  if (useShell(mode)) {
    await $`mv ${src} ${dest}`.quiet();
  } else {
    renameSync(src, dest);
  }
}

export async function rmf(path: string, mode: ShellMode = 'auto'): Promise<void> {
  if (!existsSync(path)) return;
  if (useShell(mode)) {
    await $`rm -f ${path}`.quiet();
  } else {
    rmSync(path, { force: true });
  }
}

export async function cp(src: string, dest: string, mode: ShellMode = 'auto'): Promise<void> {
  if (useShell(mode)) {
    await $`cp ${src} ${dest}`.quiet();
  } else {
    copyFileSync(src, dest);
  }
}
```

### Modes in Action

```bash
# Auto (default): Bun.$ on macOS/Linux, fs on Windows
oracle-skills install -g -y

# Force Bun.$ (test on macOS for Windows compatibility)
oracle-skills install -g -y --shell

# Force Node.js fs (if Bun.$ fails)
oracle-skills install -g -y --no-shell
```

---

## 12. Uninstallation Pipeline (installer.ts:366-437)

### Uninstall Flow

```typescript
export async function uninstallSkills(
  targetAgents: string[],
  options: { global: boolean; skills?: string[]; yes?: boolean; shellMode?: ShellMode }
): Promise<{ removed: number; agents: number }> {
  for (const agentName of targetAgents) {
    const agent = agents[agentName as keyof typeof agents];
    const targetDir = options.global ? agent.globalSkillsDir : join(process.cwd(), agent.skillsDir);

    if (!existsSync(targetDir)) continue;

    // Get installed skills (all directories except . and VERSION.md)
    const entries = readdirSync(targetDir, { withFileTypes: true });
    const installed = entries
      .filter((d) => {
        if (d.name.startsWith('.')) return false;
        if (d.name === 'VERSION.md') return false;
        return d.isDirectory();
      })
      .map((d) => d.name);

    // Filter if specific skills requested
    const toRemove = options.skills
      ? installed.filter((s) => options.skills!.includes(s))
      : installed;

    if (toRemove.length === 0) continue;

    // Remove skills from all locations
    for (const skill of toRemove) {
      const skillPath = join(targetDir, skill);
      await rmrf(skillPath, shellMode);

      // Clean up commands/ flat files
      if (agent.commandsDir) {
        const commandsDir = options.global ? agent.globalCommandsDir! : join(process.cwd(), agent.commandsDir);
        const flatFile = join(commandsDir, `${skill}.md`);
        if (existsSync(flatFile)) await rmf(flatFile, shellMode);
      }

      // Clean up from ~/.claude/plugins/ (if plugin was installed)
      const pluginPath = join(homedir(), '.claude', 'plugins', skill);
      if (existsSync(pluginPath)) {
        await rmrf(pluginPath, shellMode);
      }

      totalRemoved++;
    }
  }

  return { removed: totalRemoved, agents: agentsProcessed };
}
```

### Cleanup Scope

Removes from:
1. `skillsDir/skillname/` - Main skill folder
2. `commandsDir/skillname.md` - Command stub
3. `~/.claude/plugins/skillname/` - If installed as plugin
4. Legacy `command/` directory (old format)

---

## 13. Skill Metadata Examples

### Simple Skill (feel)

```
feel/
├── SKILL.md          # Just instructions, no code
└── [no scripts/]
```

**SKILL.md**:
```yaml
---
name: feel
description: Log emotions with optional structure
---

# /feel - Emotion Logger

Log how you're feeling...
[instructions]
```

### Complex Skill with Scripts (trace)

```
trace/
├── SKILL.md          # Instructions
└── [no scripts/]     # (code in instructions)
```

**Uses bash commands in SKILL.md** - no separate execution script needed.

### Complex Skill with Dependencies (project)

```
project/
├── SKILL.md
├── scripts/          # (if needed)
├── project-manager.md
└── templates/        # Output templates
```

### Skill with Hooks (if any)

```
[skillname]/
├── SKILL.md
├── hooks/
│   └── hooks.json
└── [other files]
```

---

## 14. CLI Commands Reference

### Main Commands (index.ts:28-288)

#### install (default)

```bash
oracle-skills install [options]

Options:
  -g, --global              # Global (user) directory
  -a, --agent <agents...>  # Specific agents
  -s, --skill <skills...>  # Specific skills
  -l, --list               # List available skills
  -y, --yes                # Skip prompts
  --commands               # Install command stubs (Claude Code opt-in)
  --shell                  # Force Bun.$ (test)
  --no-shell               # Force Node.js fs
```

#### uninstall

```bash
oracle-skills uninstall [options]

Options:
  -g, --global              # Global directory
  -a, --agent <agents...>  # Specific agents
  -s, --skill <skills...>  # Specific skills
  -y, --yes                # Skip prompts
  --shell                  # Force Bun.$
  --no-shell               # Force Node.js fs
```

#### agents

```bash
oracle-skills agents

# Lists all 15 supported agents with install status
```

#### list

```bash
oracle-skills list [options]

Options:
  -g, --global              # Global skills
  -a, --agent <agents...>  # Specific agents
```

---

## 15. Build & Release Workflow

### Local Development

```bash
cd oracle-skills-cli
bun run dev  # Run CLI directly
```

### Build for Distribution

```bash
bun run build
# Creates dist/ folder with compiled CLI
```

### Pre-Release

```bash
bun run version
# 1. bun run compile → generates src/commands/*.md
# 2. bun scripts/update-readme-table.ts → updates README.md
# 3. git add src/commands README.md → stages changes
```

### Release Script (scripts/release.sh)

```bash
./scripts/release.sh

# Does:
# 1. npm version <patch|minor|major>
# 2. Triggers pre-release hooks
# 3. Creates git tag
# 4. Pushes to GitHub
# (npm publish skipped - users install from GitHub direct)
```

### Installation from GitHub (Users)

```bash
# Direct from main branch
bunx --bun oracle-skills@github:Soul-Brews-Studio/oracle-skills-cli install -g -y

# From specific version
bunx --bun oracle-skills@github:Soul-Brews-Studio/oracle-skills-cli#v1.5.72 install -g -y

# Via curl|bash installer
curl -fsSL https://raw.githubusercontent.com/Soul-Brews-Studio/oracle-skills-cli/main/install.sh | bash
```

---

## 16. Key Implementation Details

### Why Bun Runtime?

1. **Speed**: 3-5x faster than Node.js for CLI
2. **Built-in TypeScript**: No transpile step needed
3. **Native shell**: Bun.$ is faster than child_process
4. **Single binary**: Easier distribution

**Fallback**: All Bun features have Node.js equivalents via fs-utils.ts

### Why No NPM Publish?

- Faster iteration (direct GitHub#tag installs)
- Smaller bundle size (no registry overhead)
- User trust (see actual source code)
- Version control = release control

### Orphan Cleanup Philosophy

"Nothing is Deleted" principle:
- Old skills moved to `tmpdir/oracle-skills-stale-*` (not deleted)
- Users can recover if needed
- Cleaner installs without data loss

### Global vs Local Installations

| Aspect | Local | Global |
|--------|-------|--------|
| Path | `./.claude/skills/` | `~/.claude/skills/` |
| Scope | Single project | All projects |
| Version | Can differ per project | Uniform |
| Use case | Project-specific skills | Shared skills |

---

## 17. Supported Skills (29 Total)

### Core Workflow Skills

| Skill | Type | Description |
|-------|------|-------------|
| awaken | skill | Guided Oracle birth (~15 min) |
| trace | skill + subagent | Find projects (git/MCP/agents) |
| learn | skill + subagent | Explore codebases |
| rrr | skill + subagent | Session retrospective |

### Utility Skills

| Skill | Type | Description |
|-------|------|-------------|
| philosophy | skill | Display Oracle principles |
| feel | skill | Log emotions |
| forward | skill | Handoff + plan mode |
| fyi | skill | Log information |
| who-we-are | skill | Know ourselves |
| where-we-are | skill | Session awareness |
| standup | skill | Daily standup |

### Integration Skills

| Skill | Type | Description |
|-------|------|-------------|
| project | skill + code | Clone & track repos |
| speak | skill + code | Text-to-speech |
| watch | skill + code | Learn from YouTube |
| gemini | skill + code | Control Gemini |
| physical | skill + code | Location awareness |

### Advanced Skills

| Skill | Type | Description |
|-------|------|-------------|
| recap | skill + code | Fresh-start synthesis |
| schedule | skill + code | Query schedule.md |
| deep-research | skill + code | Gemini research |
| oracle-pulse | skill | Heartbeat metrics |
| oracle-family-scan | skill | Manage Oracle family |
| oracle-soul-sync-calibrate-update | skill | Sync with family |

### Session Skills

| Skill | Type | Description |
|-------|------|-------------|
| birth | skill | Prepare new Oracle |
| merged | skill | Post-merge cleanup |
| retrospective | skill | Session retrospective |
| worktree | skill | Git worktree helper |

---

## Summary

**oracle-skills-cli** is a modular, cross-platform skill distribution system with:

1. **15 agents** - Pluggable agent detection & configuration
2. **29 skills** - Bundled workflows with markdown + optional scripts
3. **Dual mode** - Bun for speed, Node.js for compatibility
4. **Smart installation** - Auto-detection, orphan cleanup, version tracking
5. **Hook system** - Agent-specific plugins (OpenCode timestamps)
6. **Compilation** - Generate command stubs from skills
7. **Zero network** - All skills bundled in repo, no runtime download
8. **Philosophy** - "Nothing is Deleted" + "External Brain, Not Command"

The system scales from single-user installation to organization-wide skill distribution across multiple AI coding agents.

---

*Documentation generated: 2026-02-07*
*CLI Version: 1.5.72*
*Repository: https://github.com/Soul-Brews-Studio/oracle-skills-cli*
